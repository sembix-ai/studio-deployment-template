name: Deploy Sembix Studio

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Sembix Studio version to deploy (e.g., v1.2.3, main)'
        required: true
        type: string
      terraform_ref:
        description: 'Terraform workflow version (tag, branch, or commit)'
        required: false
        type: string
        default: 'v1.5.2'
      environment:
        description: 'Target environment (e.g., dev, prod, customer-specific)'
        required: true
        type: string
      run_bootstrap:
        description: 'Run bootstrap (first-time setup only)'
        type: boolean
        default: false
      run_migrations:
        description: 'Run database migrations'
        type: boolean
        default: true
      deploy_ui:
        description: 'Deploy UI to S3/CloudFront'
        type: boolean
        default: true
      require_approval:
        description: 'Require manual approval before deploying'
        type: boolean
        default: true

jobs:
  # Step 1: Validate configuration
  validate:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Generate GitHub App token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout Sembix Studio code
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.version }}

      - name: Checkout Terraform Infrastructure
        uses: actions/checkout@v3
        with:
          repository: sembix-ai/terraform-sembix-studio
          token: ${{ steps.generate-token.outputs.token }}
          path: terraform-infra
          ref: ${{ inputs.terraform_ref }}

      - name: Validate configuration
        uses: ./terraform-infra/.github/actions/validate-configuration
        with:
          version: ${{ inputs.version }}
          environment: ${{ inputs.environment }}
          auth_method: 'oidc'
          aws_region: ${{ secrets.AWS_REGION }}
          tf_bucket_name: ${{ vars.TF_BUCKET_NAME }}
          customer_role_arn: ${{ secrets.CUSTOMER_ROLE_ARN }}

          # ECR Repositories
          engine_ecr_repository_url: ${{ secrets.ENGINE_ECR_REPOSITORY_URL }}
          migrations_ecr_repository_url: ${{ secrets.MIGRATIONS_ECR_REPOSITORY_URL }}
          bff_ecr_repository_url: ${{ secrets.BFF_ECR_REPOSITORY_URL }}

          # Shared Services
          sembix_hub_aws_account_id: ${{ secrets.SEMBIX_HUB_AWS_ACCOUNT_ID }}
          sembix_hub_studio_secret_name: ${{ secrets.SEMBIX_HUB_STUDIO_SECRET_NAME }}
          sembix_hub_studio_kms_key_id: ${{ secrets.SEMBIX_HUB_STUDIO_KMS_KEY_ID }}

          # Database
          sembix_studio_db_name: ${{ secrets.SEMBIX_STUDIO_DB_NAME }}
          sembix_studio_user: ${{ secrets.SEMBIX_STUDIO_USER }}

          # Storage
          sembix_studio_artifact_s3_bucket: ${{ secrets.SEMBIX_STUDIO_ARTIFACT_S3_BUCKET }}

          # Optional configurations
          use_custom_networking: ${{ secrets.USE_CUSTOM_NETWORKING }}
          custom_vpc_id: ${{ secrets.CUSTOM_VPC_ID }}
          custom_public_subnet_ids: ${{ secrets.CUSTOM_PUBLIC_SUBNET_IDS }}
          custom_private_subnet_ids: ${{ secrets.CUSTOM_PRIVATE_SUBNET_IDS }}
          use_custom_iam_policies: ${{ secrets.USE_CUSTOM_IAM_POLICIES }}
          workflow_engine_execution_role_arn: ${{ secrets.WORKFLOW_ENGINE_EXECUTION_ROLE_ARN }}
          workflow_engine_task_role_arn: ${{ secrets.WORKFLOW_ENGINE_TASK_ROLE_ARN }}
          bff_ecs_task_execution_role_arn: ${{ secrets.BFF_ECS_TASK_EXECUTION_ROLE_ARN }}
          bff_ecs_task_role_arn: ${{ secrets.BFF_ECS_TASK_ROLE_ARN }}
          rds_proxy_role_arn: ${{ secrets.RDS_PROXY_ROLE_ARN }}
          use_custom_security_groups: ${{ secrets.USE_CUSTOM_SECURITY_GROUPS }}
          custom_workflow_engine_sg_id: ${{ secrets.CUSTOM_WORKFLOW_ENGINE_SG_ID }}
          custom_aurora_sg_id: ${{ secrets.CUSTOM_AURORA_SG_ID }}
          custom_rds_proxy_sg_id: ${{ secrets.CUSTOM_RDS_PROXY_SG_ID }}
          custom_bff_ecs_sg_id: ${{ secrets.CUSTOM_BFF_ECS_SG_ID }}
          bff_alb_certificate_arn: ${{ secrets.BFF_ALB_CERTIFICATE_ARN }}

  # Step 2: Bootstrap (conditional, first-time only)
  bootstrap:
    needs: validate
    if: inputs.run_bootstrap == true
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Generate GitHub App token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout Sembix Studio code
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.version }}

      - name: Checkout Terraform Infrastructure
        uses: actions/checkout@v3
        with:
          repository: sembix-ai/terraform-sembix-studio
          token: ${{ steps.generate-token.outputs.token }}
          path: terraform-infra
          ref: ${{ inputs.terraform_ref }}

      - name: Run bootstrap
        uses: ./terraform-infra/.github/actions/bootstrap-studio
        with:
          version: ${{ inputs.version }}
          environment: ${{ inputs.environment }}
          require_approval: ${{ inputs.require_approval }}
          aws_region: ${{ secrets.AWS_REGION }}
          tf_bucket_name: ${{ vars.TF_BUCKET_NAME }}
          customer_role_arn: ${{ secrets.CUSTOMER_ROLE_ARN }}
          github_token: ${{ steps.generate-token.outputs.token }}

  # Step 3: Deploy infrastructure and application
  deploy:
    needs: [validate, bootstrap]
    if: always() && needs.validate.result == 'success'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Generate GitHub App token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout Sembix Studio code
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.version }}

      - name: Checkout Terraform Infrastructure
        uses: actions/checkout@v3
        with:
          repository: sembix-ai/terraform-sembix-studio
          token: ${{ steps.generate-token.outputs.token }}
          path: terraform-infra
          ref: ${{ inputs.terraform_ref }}

      - name: Deploy Sembix Studio
        uses: ./terraform-infra/.github/actions/deploy-studio
        with:
          version: ${{ inputs.version }}
          environment: ${{ inputs.environment }}
          run_migrations: ${{ inputs.run_migrations }}
          deploy_ui: ${{ inputs.deploy_ui }}
          require_approval: ${{ inputs.require_approval }}
          github_token: ${{ steps.generate-token.outputs.token }}

          # AWS Core
          aws_region: ${{ secrets.AWS_REGION }}
          tf_bucket_name: ${{ vars.TF_BUCKET_NAME }}
          customer_role_arn: ${{ secrets.CUSTOMER_ROLE_ARN }}

          # ECR Repositories
          engine_ecr_repository_url: ${{ secrets.ENGINE_ECR_REPOSITORY_URL }}
          migrations_ecr_repository_url: ${{ secrets.MIGRATIONS_ECR_REPOSITORY_URL }}
          bff_ecr_repository_url: ${{ secrets.BFF_ECR_REPOSITORY_URL }}

          # Shared Services & Cross-Account
          sembix_hub_aws_account_id: ${{ secrets.SEMBIX_HUB_AWS_ACCOUNT_ID }}
          sembix_hub_studio_secret_name: ${{ secrets.SEMBIX_HUB_STUDIO_SECRET_NAME }}
          sembix_hub_studio_kms_key_id: ${{ secrets.SEMBIX_HUB_STUDIO_KMS_KEY_ID }}
          sembix_hub_consumer_role_arn: ${{ secrets.SEMBIX_HUB_HUB_CONSUMER_ROLE_ARN }}
          sembix_hub_admin_role_arn: ${{ secrets.SEMBIX_HUB_HUB_ADMIN_ROLE_ARN }}
          sembix_hub_app_config_role_arn: ${{ secrets.SEMBIX_HUB_APP_CONFIG_ROLE_ARN }}
          sembix_hub_app_config_app_id: ${{ secrets.SEMBIX_HUB_APP_CONFIG_APP_ID }}
          sembix_hub_app_config_env_id: ${{ secrets.SEMBIX_HUB_APP_CONFIG_ENV_ID }}
          sembix_hub_app_config_profile_id: ${{ secrets.SEMBIX_HUB_APP_CONFIG_PROFILE_ID }}
          sembix_hub_engine_execution_role: ${{ secrets.SEMBIX_HUB_ENGINE_EXECUTION_ROLE }}

          # Database Configuration
          sembix_studio_db_name: ${{ secrets.SEMBIX_STUDIO_DB_NAME }}
          sembix_studio_user: ${{ secrets.SEMBIX_STUDIO_USER }}

          # Networking Configuration
          use_custom_networking: ${{ secrets.USE_CUSTOM_NETWORKING }}
          custom_vpc_id: ${{ secrets.CUSTOM_VPC_ID }}
          custom_public_subnet_ids: ${{ secrets.CUSTOM_PUBLIC_SUBNET_IDS }}
          custom_private_subnet_ids: ${{ secrets.CUSTOM_PRIVATE_SUBNET_IDS }}
          vpc_cidr: ${{ secrets.VPC_CIDR }}
          public_subnet_cidrs: ${{ secrets.PUBLIC_SUBNET_CIDRS }}
          private_subnet_cidrs: ${{ secrets.PRIVATE_SUBNET_CIDRS }}
          az_count: ${{ secrets.AZ_COUNT }}
          enable_vpc_endpoints: ${{ secrets.ENABLE_VPC_ENDPOINTS }}

          # Security Groups
          use_custom_security_groups: ${{ secrets.USE_CUSTOM_SECURITY_GROUPS }}
          custom_workflow_engine_sg_id: ${{ secrets.CUSTOM_WORKFLOW_ENGINE_SG_ID }}
          custom_aurora_sg_id: ${{ secrets.CUSTOM_AURORA_SG_ID }}
          custom_rds_proxy_sg_id: ${{ secrets.CUSTOM_RDS_PROXY_SG_ID }}
          custom_bff_ecs_sg_id: ${{ secrets.CUSTOM_BFF_ECS_SG_ID }}
          custom_bastion_sg_id: ${{ secrets.CUSTOM_BASTION_SG_ID }}
          custom_bff_alb_sg_id: ${{ secrets.CUSTOM_BFF_ALB_SG_ID }}

          # IAM Roles & Policies
          use_custom_iam_policies: ${{ secrets.USE_CUSTOM_IAM_POLICIES }}
          workflow_engine_execution_role_arn: ${{ secrets.WORKFLOW_ENGINE_EXECUTION_ROLE_ARN }}
          workflow_engine_task_role_arn: ${{ secrets.WORKFLOW_ENGINE_TASK_ROLE_ARN }}
          bff_ecs_task_execution_role_arn: ${{ secrets.BFF_ECS_TASK_EXECUTION_ROLE_ARN }}
          bff_ecs_task_role_arn: ${{ secrets.BFF_ECS_TASK_ROLE_ARN }}
          rds_proxy_role_arn: ${{ secrets.RDS_PROXY_ROLE_ARN }}
          sembix_studio_memory_role_arn: ${{ secrets.SEMBIX_STUDIO_MEMORY_ROLE_ARN }}
          sembix_studio_notification_role_arn: ${{ secrets.SEMBIX_STUDIO_NOTIFICATION_ROLE_ARN }}

          # TLS/SSL Certificates
          sembix_studio_cf_viewer_cert: ${{ secrets.SEMBIX_STUDIO_CF_VIEWER_CERT }}
          bff_alb_certificate_arn: ${{ secrets.BFF_ALB_CERTIFICATE_ARN }}

          # DNS & Route53
          hosted_zone_id: ${{ secrets.HOSTED_ZONE_ID }}
          cloudfront_domain: ${{ vars.CLOUDFRONT_DOMAIN }}

          # Bastion Host
          bastion_ami_id: ${{ secrets.BASTION_AMI_ID }}
          bastion_ssh_key_name: ${{ secrets.BASTION_SSH_KEY_NAME }}

          # Storage & Artifacts
          sembix_studio_artifact_s3_bucket: ${{ secrets.SEMBIX_STUDIO_ARTIFACT_S3_BUCKET }}

          # Frontend configuration.
          vite_github_app_client_id: ${{ vars.VITE_GITHUB_APP_CLIENT_ID }}
          vite_github_app_name: ${{ vars.VITE_GITHUB_APP_NAME }}
          vite_jira_client_id: ${{ vars.VITE_JIRA_CLIENT_ID }}

          # Module Configuration
          enable_bpa: ${{ vars.ENABLE_BPA }}
          deploy_sembix_studio_memory: ${{ vars.DEPLOY_SEMBIX_STUDIO_MEMORY }}
          deploy_sembix_studio_notifications: ${{ vars.DEPLOY_SEMBIX_STUDIO_NOTIFICATIONS }}
          enable_bff_waf: ${{ vars.ENABLE_BFF_WAF }}

          # Approvers
          approvers: ${{ secrets.DEPLOYMENT_APPROVERS }}
