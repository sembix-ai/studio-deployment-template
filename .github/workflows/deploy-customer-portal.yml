name: Deploy Customer Portal Web

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.2.3)'
        required: true
        type: string
      environment:
        description: 'Target environment (e.g., dev, staging, prod)'
        required: true
        type: string
      terraform_ref:
        description: 'Terraform workflow version (tag, branch, or commit)'
        required: false
        type: string
        default: 'v4.2.2'

jobs:
  deploy-customer-portal:
    name: Deploy Customer Portal
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Validate Inputs
        run: |
          # Validate version input
          if [[ ! "${{ inputs.version }}" =~ ^[a-zA-Z0-9._-]+$ ]]; then
            echo "Error: Invalid version format. Only alphanumeric characters, dots, underscores, and hyphens are allowed."
            exit 1
          fi

          # Validate environment input
          if [[ ! "${{ inputs.environment }}" =~ ^[a-zA-Z0-9._-]+$ ]]; then
            echo "Error: Invalid environment format. Only alphanumeric characters, dots, underscores, and hyphens are allowed."
            exit 1
          fi

          # Set sanitized environment variables
          echo "SAFE_VERSION=${{ inputs.version }}" >> $GITHUB_ENV
          echo "SAFE_ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV

      - name: Generate GitHub App token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: sembix-ai

      - name: Checkout Deployment Code
        uses: actions/checkout@v3
        with:
          token: ${{ github.token }}

      - name: Checkout Terraform Infrastructure
        uses: actions/checkout@v3
        with:
          repository: sembix-ai/sembix-studio-infrastructure
          token: ${{ steps.generate-token.outputs.token }}
          path: terraform-infra
          ref: ${{ inputs.terraform_ref }}

      - name: Deploy Customer Portal
        uses: ./terraform-infra/.github/actions/deploy-customer-portal
        with:
          version: ${{ env.SAFE_VERSION }}
          environment: ${{ env.SAFE_ENVIRONMENT }}
          require_approval: 'true'
          aws_region: ${{ secrets.AWS_REGION }}
          tf_bucket_name: ${{ vars.TF_BUCKET_NAME }}
          customer_role_arn: ${{ secrets.CUSTOMER_ROLE_ARN }}
          cloudfront_domain: ${{ secrets.CUSTOMER_PORTAL_CLOUDFRONT_DOMAIN }}
          viewer_certificate_arn: ${{ secrets.CUSTOMER_PORTAL_CF_ARN }}
          hosted_zone_id: ${{ secrets.CUSTOMER_PORTAL_HOSTED_ZONE_ID }}
          cognito_password_minimum_length: ${{ vars.CUSTOMER_PORTAL_COGNITO_PASSWORD_MIN_LENGTH || '8' }}
          central_hub_role_arn: ${{ secrets.CUSTOMER_PORTAL_CENTRAL_HUB_ROLE_ARN }}
          central_hub_base_url: ${{ secrets.CUSTOMER_PORTAL_CENTRAL_HUB_API_URL }}
          customer_portal_data_bucket_name: ${{ secrets.CUSTOMER_PORTAL_DATA_BUCKET_NAME }}
          log_level: ${{ vars.CUSTOMER_PORTAL_LOG_LEVEL || 'info' }}
          github_token: ${{ steps.generate-token.outputs.token }}
          approvers: ${{ secrets.DEPLOYMENT_APPROVERS }}
          deploy_ui: 'true'
          sembix_hub_aws_account_id: ${{ secrets.SHARED_SERVICES_AWS_ACCOUNT_ID }}

      - name: Deployment Summary
        env:
          VERSION: ${{ env.SAFE_VERSION }}
          ENVIRONMENT: ${{ env.SAFE_ENVIRONMENT }}
        run: |
          echo "## Customer Portal Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${ENVIRONMENT}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Successfully deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Customer Portal is now live!" >> $GITHUB_STEP_SUMMARY
